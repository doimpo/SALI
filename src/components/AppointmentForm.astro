---
/**
 * Appointment Form Component
 * Reusable form for booking appointments across all locations
 * Includes spam protection (honeypot + reCAPTCHA v3) and AI tagging
 */

interface Props {
  location?: string;
  formTitle?: string;
  formDescription?: string;
  showClinicSelector?: boolean;
  showDoctorSelector?: boolean;
}

const { 
  location = '',
  formTitle = 'Book An Appointment',
  formDescription = 'Please feel welcome to contact our friendly reception staff with any general or medical enquiry. Our doctors will receive or return any urgent calls.',
  showClinicSelector = true,
  showDoctorSelector = true,
} = Astro.props;

// Generate unique form name
const formName = location ? `appointment-${location}` : 'appointment';
---

<div class="contact-panel mb-50">
  <form 
    class="contact-panel__form appointment-form" 
    method="post" 
    data-netlify="true" 
    data-netlify-honeypot="bot-field"
    name={formName}
    id={formName}
  >
    <!-- Required hidden fields for Netlify Forms -->
    <input type="hidden" name="form-name" value={formName} />
    <input type="hidden" name="form-type" value="appointment" />
    {location && <input type="hidden" name="form-location" value={location} />}
    
    <!-- Honeypot field for spam protection -->
    <p class="hidden" aria-hidden="true">
      <label>
        Don't fill this out if you're human: <input name="bot-field" tabindex="-1" />
      </label>
    </p>
    
    <div class="row">
      <div class="col-sm-12">
        <h4 class="contact-panel__title">{formTitle}</h4>
        <p class="contact-panel__desc mb-30">{formDescription}</p>
      </div>
      
      {showClinicSelector && (
        <div class="col-sm-6 col-md-6 col-lg-6">
          <div class="form-group">
            <i class="icon-widget form-group-icon"></i>
            <select class="form-control" name="clinic" id="clinic" required>
              <option value="">Choose Clinic *</option>
              <option value="hyderabad">Hyderabad - Banjara Hills</option>
              <option value="mumbai">Mumbai</option>
              <option value="kolkata">Kolkata</option>
              <option value="visakhapatnam">Visakhapatnam</option>
              <option value="vijayawada-guntur">Vijayawada-Guntur</option>
              <option value="rajahmundry">Rajahmundry</option>
              <option value="kakinada">Kakinada</option>
              <option value="nagpur">Nagpur</option>
              <option value="anantapur">Anantapur</option>
              <option value="khammam">Khammam</option>
              <option value="kurnool">Kurnool</option>
              <option value="rajkot">Rajkot</option>
              <option value="jabalpur">Jabalpur</option>
            </select>
          </div>
        </div>
      )}
      
      {showDoctorSelector && (
        <div class="col-sm-6 col-md-6 col-lg-6">
          <div class="form-group">
            <i class="icon-user form-group-icon"></i>
            <select class="form-control" name="doctor-preference" id="doctor-preference">
              <option value="">Doctor Preference (Optional)</option>
              <option value="any">Any Available Doctor</option>
              <option value="specialist">Liver Specialist</option>
              <option value="transplant-surgeon">Transplant Surgeon</option>
            </select>
          </div>
        </div>
      )}
      
      <div class="col-sm-6 col-md-6 col-lg-6">
        <div class="form-group">
          <i class="icon-news form-group-icon"></i>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Full Name *" 
            name="contact-name" 
            id="contact-name"
            required
            minlength="2"
            maxlength="100"
          />
        </div>
      </div>
      
      <div class="col-sm-6 col-md-6 col-lg-6">
        <div class="form-group">
          <i class="icon-email form-group-icon"></i>
          <input 
            type="email" 
            class="form-control" 
            placeholder="Email Address *" 
            name="contact-email"
            id="contact-email" 
            required
          />
        </div>
      </div>
      
      <div class="col-sm-4 col-md-4 col-lg-4">
        <div class="form-group">
          <i class="icon-phone form-group-icon"></i>
          <input 
            type="tel" 
            class="form-control" 
            placeholder="Phone Number *" 
            name="contact-phone"
            id="contact-phone" 
            required
            pattern="[0-9+\-\s()]+"
            title="Please enter a valid phone number"
          />
        </div>
      </div>
      
      <div class="col-sm-4 col-md-4 col-lg-4">
        <div class="form-group form-group-date">
          <i class="icon-calendar form-group-icon"></i>
          <input 
            type="date" 
            class="form-control" 
            name="contact-date" 
            id="contact-date"
            required
            min={new Date().toISOString().split('T')[0]}
          />
        </div>
      </div>
      
      <div class="col-sm-4 col-md-4 col-lg-4">
        <div class="form-group form-group-date">
          <i class="icon-clock form-group-icon"></i>
          <input 
            type="time" 
            class="form-control" 
            name="contact-time" 
            id="contact-time"
            required
          />
        </div>
      </div>
      
      <div class="col-12">
        <div class="form-group">
          <i class="icon-alert form-group-icon"></i>
          <textarea 
            class="form-control" 
            placeholder="Reason for Visit / Medical Concern (Optional)" 
            name="contact-message"
            id="contact-message"
            rows="3"
            maxlength="1000"
          ></textarea>
          <small class="form-text text-muted">Please describe your medical concern or reason for consultation</small>
        </div>
      </div>
      
      <div class="col-12">
        <button 
          type="submit" 
          class="btn btn__secondary btn__rounded btn__block btn__xhight mt-10"
        >
          <span>Book Appointment</span> <i class="icon-arrow-right"></i>
        </button>
        <div class="contact-result mt-3" role="alert"></div>
        <small class="form-text text-muted mt-2">
          By submitting this form, you agree to our privacy policy. We will contact you within 24 hours.
        </small>
      </div>
    </div>
  </form>
</div>

<style>
  .hidden {
    display: none;
  }
  
  .contact-result {
    min-height: 20px;
  }
  
  .contact-result.success {
    padding: 15px;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 4px;
    color: #155724;
  }
  
  .contact-result.error {
    padding: 15px;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    color: #721c24;
  }
  
  .contact-result.loading {
    padding: 15px;
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 4px;
    color: #0c5460;
  }
</style>

<script>
  // Form submission handler with reCAPTCHA v3
  document.addEventListener('DOMContentLoaded', () => {
    const forms = document.querySelectorAll('.appointment-form');
    
    forms.forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const resultDiv = form.querySelector('.contact-result');
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHTML = submitButton.innerHTML;
        
        // Show loading state
        resultDiv.className = 'contact-result loading';
        resultDiv.textContent = 'Processing your appointment request...';
        submitButton.disabled = true;
        submitButton.innerHTML = '<span>Processing...</span>';
        
        try {
          // Get reCAPTCHA token (will be added when we integrate reCAPTCHA)
          let token = '';
          if (window.grecaptcha) {
            token = await window.grecaptcha.execute(window.RECAPTCHA_SITE_KEY, { action: 'submit' });
          }
          
          // Add token to form data
          const formData = new FormData(form);
          if (token) {
            formData.append('g-recaptcha-response', token);
          }
          
          // Submit to Netlify
          const response = await fetch(form.action || '/', {
            method: 'POST',
            body: new URLSearchParams(formData),
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
          });
          
          if (response.ok) {
            resultDiv.className = 'contact-result success';
            resultDiv.innerHTML = '<strong>✓ Success!</strong> Your appointment request has been received. We will contact you shortly to confirm.';
            form.reset();
          } else {
            throw new Error('Submission failed');
          }
          
        } catch (error) {
          resultDiv.className = 'contact-result error';
          resultDiv.innerHTML = '<strong>✗ Error:</strong> There was a problem submitting your request. Please try again or call us at +91-8070 670 670.';
        } finally {
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonHTML;
          
          // Scroll to result
          resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    });
  });
</script>

